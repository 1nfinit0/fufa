---
// /src/data/banners.ts
import { getBanners } from '@data/banners';

const bannersList = getBanners();
---
<div class="banner-carousel">
  <div class="slides-container">
    {bannersList.map((banner, index) => (
      <div 
        class={`slide ${index === 0 ? 'active' : ''}`}
        data-slide={index}
      >
        {banner.linkUrl ? (
          <a href={banner.linkUrl}>
            <img src={banner.imageUrl} alt={banner.altText} />
          </a>
        ) : (
          <img src={banner.imageUrl} alt={banner.altText} />
        )}
      </div>
    ))}
  </div>

  <div class="dots">
    {bannersList.map((_, index) => (
      <button 
        class={`dot ${index === 0 ? 'active' : ''}`}
        data-slide={index}
      />
    ))}
  </div>
</div>

<style> 
  .banner-carousel {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .slides-container {
    position: relative;
    width: 100%;
    height: 500px;
  }

  .slide {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .slide.active {
    opacity: 1;
    z-index: 1;
  }

  .slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
  }

  .dots {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.5rem;
    z-index: 10;
  }

  .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    border: none;
    cursor: pointer;
    padding: 0;
    transition: background 0.2s;
  }

  .dot.active {
    background: white;
  }

  @media (max-width: 768px) {
    .slides-container {
      height: 300px;
    }
  }
</style>

<script>
  // Estado del carrusel
  let currentSlide = 0;
  let slides: NodeListOf<Element> = document.querySelectorAll('.slide');
  let dots: NodeListOf<Element> = document.querySelectorAll('.dot');
  let totalSlides = 0;
  
  // Variables para el deslizamiento
  let startX = 0;
  let currentX = 0;
  let isDragging = false;
  let autoPlayInterval: ReturnType<typeof setInterval> | null = null;
  
  // Inicialización
  function initCarousel() {
    const carousel = document.querySelector('.banner-carousel');
    const slidesContainer = document.querySelector('.slides-container');
    
    if (!carousel || !slidesContainer) return;
    
    slides = document.querySelectorAll('.slide');
    dots = document.querySelectorAll('.dot');
    totalSlides = slides.length;
    
    // Detener auto-play anterior si existe
    if (autoPlayInterval) {
      clearInterval(autoPlayInterval);
    }
    
    // Mostrar slide actual
    function showSlide(index: number) {
      // Asegurar que el índice esté dentro de los límites (bucle infinito)
      currentSlide = (index + totalSlides) % totalSlides;
      
      // Quita active de todos
      slides.forEach(slide => slide.classList.remove('active'));
      dots.forEach(dot => dot.classList.remove('active'));
      
      // Añade active al actual
      slides[currentSlide].classList.add('active');
      dots[currentSlide].classList.add('active');
    }
    
    // Navegación simple
    function nextSlide() {
      showSlide(currentSlide + 1);
    }
    
    function prevSlide() {
      showSlide(currentSlide - 1);
    }
    
    // Eventos de dots
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        showSlide(index);
        resetAutoPlay();
      });
    });
    
    // =====================
    // DESLIZAMIENTO SIMPLE
    // =====================
    
    function handleStart(e: Event) {
      if (e instanceof MouseEvent) {
        startX = e.clientX;
      } else if (e instanceof TouchEvent) {
        startX = e.touches[0].clientX;
      }
      currentX = 0;
      isDragging = true;
      
      // Detener auto-play temporalmente
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
      }
    }
    
    function handleMove(e: Event) {
      if (!isDragging) return;
      if (e instanceof MouseEvent) {
        currentX = e.clientX - startX;
      } else if (e instanceof TouchEvent) {
        currentX = e.touches[0].clientX - startX;
      }
    }
    
    function handleEnd(e?: Event) {
      if (!isDragging) return;
      isDragging = false;
      
      // Decidir si cambiar de slide
      const threshold = window.innerWidth * 0.1; // 10% de la pantalla
      
      if (currentX < -threshold) {
        // Deslizamiento a la derecha: siguiente
        nextSlide();
      } else if (currentX > threshold) {
        // Deslizamiento a la izquierda: anterior
        prevSlide();
      }
      
      // Reiniciar auto-play
      resetAutoPlay();
      currentX = 0;
    }
    
    // Eventos de mouse
    slidesContainer.addEventListener('mousedown', handleStart as EventListener);
    document.addEventListener('mousemove', handleMove as EventListener);
    document.addEventListener('mouseup', handleEnd as EventListener);
    
    // Eventos táctiles
    slidesContainer.addEventListener('touchstart', handleStart as EventListener, { passive: true });
    document.addEventListener('touchmove', handleMove as EventListener, { passive: true });
    document.addEventListener('touchend', handleEnd as EventListener);
    
    // Prevenir arrastre de imágenes
    slidesContainer.querySelectorAll('img').forEach(img => {
      img.addEventListener('dragstart', (e) => e.preventDefault());
    });
    
    // Auto-play simple
    function startAutoPlay() {
      autoPlayInterval = setInterval(nextSlide, 4000);
    }
    
    function resetAutoPlay() {
      if (autoPlayInterval) {
        clearInterval(autoPlayInterval);
      }
      startAutoPlay();
    }
    
    // Inicializar
    showSlide(currentSlide);
    startAutoPlay();
  }
  
  // Inicialización segura
  document.addEventListener('DOMContentLoaded', initCarousel);
  document.addEventListener('astro:page-load', initCarousel);
</script>